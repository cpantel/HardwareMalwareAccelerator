#include "xparameters.h"
#include "xstatus.h"
#include "xuartlite_l.h"
#include "xil_printf.h"

#define UARTLITE_BASEADDR_0    XPAR_UARTLITE_0_BASEADDR
#define XOR_ACCELL_BASEADDR    XPAR_LEAKY_ACCELERATOR_0_S00_AXI_BASEADDR
#define REG_KEY        0
#define REG_CLEARTEXT  4
#define REG_CIPHERTEXT 8

union Data {
   u32 asInt;
   u8 asU8[4];
};

int main(void) {

    union Data data;
    u8 eol = 0x0a;

    xil_printf("Accelerator\r\n");

    Xil_Out32(XOR_ACCELL_BASEADDR + REG_KEY, 0x05050505);

    while (1) {
        data.asInt = 0;
        for (int idx = 0; idx < 4; ++idx) {
          data.asU8[idx] =  XUartLite_RecvByte(UARTLITE_BASEADDR_0);
          XUartLite_SendByte(UARTLITE_BASEADDR_0, data.asU8[idx]);
          xil_printf("echoed back %c\r\n", data.asU8[idx] );
        }
        XUartLite_SendByte(UARTLITE_BASEADDR_0, eol);

        Xil_Out32(XOR_ACCELL_BASEADDR + REG_CLEARTEXT, data.asInt);
        data.asInt = Xil_In32(XOR_ACCELL_BASEADDR + REG_CIPHERTEXT);

        for (int idx = 0; idx < 4; ++idx) {
          XUartLite_SendByte(UARTLITE_BASEADDR_0, data.asU8[idx]);
          xil_printf("ciphertext  %c\r\n", data.asU8[idx] );
        }
        XUartLite_SendByte(UARTLITE_BASEADDR_0, eol);
    }
    return 0;
}

